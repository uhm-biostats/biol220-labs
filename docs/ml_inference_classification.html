<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>process-models-workshop - 11&nbsp; ML model selection with MESS simulations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ml_inference_regression.html" rel="next">
<link href="./mess_simulations.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ML model selection with MESS simulations</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">process-models-workshop</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software_setup.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Software setup</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_process_models.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Theory and motivation of process modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coding_neutral_theory.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Coding exercise: A simple neutral model of biodiversity</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./neutral_theory_sims.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Simulation Exercise: Exploring neutral model behavior</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ml_inference_neutral.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Inferring the parameters of UNTB from outcomes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day_1_wrapup.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Day 1 wrap-up</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_mess.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction to the MESS Model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mess_getting_started.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Getting started with the MESS model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mess_simulations.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using MESS API mode in RStudio to explore hypotheses</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ml_inference_classification.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ML model selection with MESS simulations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ml_inference_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ML parameter estimation with MESS simulations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrapup.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Wrap-up</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#key-questions" id="toc-key-questions" class="nav-link active" data-scroll-target="#key-questions"> <span class="header-section-number">11.1</span> Key questions</a></li>
  <li><a href="#lesson-objectives" id="toc-lesson-objectives" class="nav-link" data-scroll-target="#lesson-objectives"> <span class="header-section-number">11.2</span> Lesson objectives</a></li>
  <li><a href="#planned-exercises" id="toc-planned-exercises" class="nav-link" data-scroll-target="#planned-exercises"> <span class="header-section-number">11.3</span> Planned exercises</a>
  <ul class="collapse">
  <li><a href="#lecture-how-does-ml-work-with-mess-simulations" id="toc-lecture-how-does-ml-work-with-mess-simulations" class="nav-link" data-scroll-target="#lecture-how-does-ml-work-with-mess-simulations"> <span class="header-section-number">11.3.1</span> Lecture: How does ML work with MESS simulations?</a></li>
  <li><a href="#motivating-community-assembly-model-classification" id="toc-motivating-community-assembly-model-classification" class="nav-link" data-scroll-target="#motivating-community-assembly-model-classification"> <span class="header-section-number">11.3.2</span> Motivating community assembly model classification</a></li>
  <li><a href="#run-mess-simulations" id="toc-run-mess-simulations" class="nav-link" data-scroll-target="#run-mess-simulations"> <span class="header-section-number">11.3.3</span> Run MESS simulations</a></li>
  <li><a href="#implement-ml-assembly-model-classification" id="toc-implement-ml-assembly-model-classification" class="nav-link" data-scroll-target="#implement-ml-assembly-model-classification"> <span class="header-section-number">11.3.4</span> Implement ML assembly model classification</a></li>
  <li><a href="#predict-assembly-model-of-empirical-data" id="toc-predict-assembly-model-of-empirical-data" class="nav-link" data-scroll-target="#predict-assembly-model-of-empirical-data"> <span class="header-section-number">11.3.5</span> <strong>Predict assembly model of empirical data</strong></a></li>
  <li><a href="#hands-on-exercise-predicting-assembly_model-of-mystery-simulations" id="toc-hands-on-exercise-predicting-assembly_model-of-mystery-simulations" class="nav-link" data-scroll-target="#hands-on-exercise-predicting-assembly_model-of-mystery-simulations"> <span class="header-section-number">11.3.6</span> Hands-on Exercise: Predicting <code>assembly_model</code> of mystery simulations</a></li>
  <li><a href="#more-to-explore-with-r-randomforest-package" id="toc-more-to-explore-with-r-randomforest-package" class="nav-link" data-scroll-target="#more-to-explore-with-r-randomforest-package"> <span class="header-section-number">11.3.7</span> More to explore with R <code>randomForest</code> package</a></li>
  </ul></li>
  <li><a href="#key-points" id="toc-key-points" class="nav-link" data-scroll-target="#key-points"> <span class="header-section-number">11.4</span> Key points</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ML model selection with MESS simulations</span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="key-questions" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="key-questions"><span class="header-section-number">11.1</span> Key questions</h2>
<ol type="1">
<li>What do I <strong>do</strong> with all these MESS simulations?</li>
<li>How do I perform ML inference using MESS simulations in R?</li>
</ol>
</section>
<section id="lesson-objectives" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="lesson-objectives"><span class="header-section-number">11.2</span> Lesson objectives</h2>
<p>After this lesson, learners should be able to…</p>
<ol type="1">
<li>Use MESS simulations and RandomForest ML to perform community assembly model selection (classification)</li>
<li>Evaluate uncertainty in classification accuracy using confusion matrices</li>
<li>Apply ML Classification to empirical data and interpret results in terms of story</li>
<li>Brainstorm applications to other systems/empirical datasets</li>
</ol>
</section>
<section id="planned-exercises" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="planned-exercises"><span class="header-section-number">11.3</span> Planned exercises</h2>
<ul>
<li>Lecture: How does ML work with MESS simulations?</li>
<li>Motivating community assembly model classification</li>
<li>Get the MESS simulations and do some set-up</li>
<li>Overview of major steps of machine learning process</li>
<li>Implement ML assembly model classification</li>
<li>Hands-on Exercise: Predicting <code>assembly_model</code> of mystery simulations</li>
</ul>
<section id="lecture-how-does-ml-work-with-mess-simulations" class="level3" data-number="11.3.1">
<h3 data-number="11.3.1" class="anchored" data-anchor-id="lecture-how-does-ml-work-with-mess-simulations"><span class="header-section-number">11.3.1</span> Lecture: How does ML work with MESS simulations?</h3>
<p>Lecture: <a href="https://docs.google.com/presentation/d/12fVO8Jzxvdm5nxcvITtpn3re8VJm4j1J96Y3zmBh6ZY/edit?usp=sharing">How does machine learning work with MESS simulations?</a></p>
</section>
<section id="motivating-community-assembly-model-classification" class="level3" data-number="11.3.2">
<h3 data-number="11.3.2" class="anchored" data-anchor-id="motivating-community-assembly-model-classification"><span class="header-section-number">11.3.2</span> Motivating community assembly model classification</h3>
<p>The first step is now to assess the model of community assembly that best fits the data. The three models are <code>neutral</code>, in which all individuals are ecologically equivalent; <code>competition</code>, in which species have traits, and differential survival probability is weighted by distance of traits from the trait mean in the local community (closer to the trait mean == higher probability of death); and <code>filtering</code>, in which there is an environmental optimum, and proximity of trait values to this optimum is positively correlated with survival probability.</p>
<p>Basically we want to know, are individuals in the local community ecologically equivalent, and if not are they interacting more with each other or more with the local environment. To accomplish this, we are going to use <strong>simulation-based supervised machine learning</strong>, which is what the rest of this lesson is all about.</p>
</section>
<section id="run-mess-simulations" class="level3" data-number="11.3.3">
<h3 data-number="11.3.3" class="anchored" data-anchor-id="run-mess-simulations"><span class="header-section-number">11.3.3</span> Run MESS simulations</h3>
<p>Ok, so now we know what we want to know: Are the “data” (the Hill # summary statistics for abundance, traits, and genetics) sufficient to distinguish among community assembly models? How do we go about evaluating this question? Well, the first step is to generate a large number simuations under each of the three assembly models, so we have a representative sample of patterns in the data characteristic of each assembly model.</p>
<p><strong>Coding exercise:</strong> Create a new <code>MESS$Core</code> object and use a <code>for</code> loop to run 2 simulations for each of the three community assembly models: <code>neutral</code>, <code>competition</code>, and <code>filtering</code>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution: Running a loop over assembly models to generate simulations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>MESS <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"iBioGen"</span>, <span class="at">as=</span><span class="st">"MESS"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>core <span class="ot">=</span> MESS<span class="sc">$</span><span class="fu">Core</span>(<span class="st">"watdo"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Set all the parameters common to all simulations</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"ntaxa"</span>, <span class="st">"300"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"J"</span>, <span class="st">"40000-150000"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"colrate"</span>, <span class="st">"0.0001-0.005"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"ecological_strength"</span>, <span class="st">"0.1-10.0"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"local_stop_criterion"</span>, <span class="st">"equilibrium"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"local_stop_time"</span>, <span class="st">"0.5-1.0"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (model <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"neutral"</span>, <span class="st">"competition"</span>, <span class="st">"filtering"</span>)){</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  core<span class="sc">$</span><span class="fu">set_param</span>(<span class="st">"assembly_model"</span>, model)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  core<span class="sc">$</span><span class="fu">simulate</span>(<span class="at">nsims=</span><span class="dv">2</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<section id="download-the-pre-baked-simulations" class="level4" data-number="11.3.3.1">
<h4 data-number="11.3.3.1" class="anchored" data-anchor-id="download-the-pre-baked-simulations"><span class="header-section-number">11.3.3.1</span> Download the pre-baked simulations</h4>
<p>Since it can take quite some time to run a number of simulations sufficient for model selection and parameter estimation we will use a suite of pre-baked simulations generated ahead of time. We want to practice good organizational habits for our simulations and .R scripts, so as a challenge, before downloading the simulations file, **make a new directory in your home directory called “MESS-inference” and change directory into it.*</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution: Make a ‘MESS-inference’ directory in your home directory
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb2"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>## Make sure you are in your home directory</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cd ~</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>## Make the 'MESS-inference' directory</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>mkdir MESS-inference</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>## change into the new directory</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>cd MESS-inference</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>## print working directory to verify you are where you should be</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>pwd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>/home/rstudio/MESS-inference</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Once you are in the <code>/home/rstudio/MESS-inference</code> directory, you may fetch the simulations from the workshop site using <code>wget</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>wget https://github.com/role-model/process-models-workshop/raw/main/data/MESS-SIMOUT.csv.gz</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>gunzip MESS-SIMOUT.csv.gz</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>wc -l MESS-SIMOUT.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>MESS-SIMOUT.csv.gz   100%[====================&gt;]  35.24M  1.12MB/s    in 32s
2023-06-15 14:31:54 (1.12 MB/s) - ‘MESS-SIMOUT.csv.gz’ saved [36954693/36954693]
3000 SIMOUT.txt</code></pre>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>wc</code> command counts the number of lines if you pass it the <code>-l</code> flag. You can see this series of 3000 simulations is about 35MB gzipped.</p>
</div>
</div>
</section>
</section>
<section id="implement-ml-assembly-model-classification" class="level3" data-number="11.3.4">
<h3 data-number="11.3.4" class="anchored" data-anchor-id="implement-ml-assembly-model-classification"><span class="header-section-number">11.3.4</span> Implement ML assembly model classification</h3>
<section id="overview-of-major-steps-of-simulation-based-machine-learning-process" class="level4" data-number="11.3.4.1">
<h4 data-number="11.3.4.1" class="anchored" data-anchor-id="overview-of-major-steps-of-simulation-based-machine-learning-process"><span class="header-section-number">11.3.4.1</span> Overview of major steps of simulation-based machine learning process</h4>
<p>Before we dive in, it’s maybe useful to have an idea of the roadmap of what we’ll be doing. The <em>major</em> steps of implementing simulation-based machine learning are:</p>
<ul>
<li>Load the simulations and do some set-up</li>
<li>Transform the simulations</li>
<li>Train the ML model</li>
<li>Evaluate how well it trained</li>
<li>Apply it to real data</li>
<li>Clean up and you’re done</li>
</ul>
</section>
<section id="do-some-set-up" class="level4" data-number="11.3.4.2">
<h4 data-number="11.3.4.2" class="anchored" data-anchor-id="do-some-set-up"><span class="header-section-number">11.3.4.2</span> <strong>Do some set-up</strong></h4>
<p>Looking in the “Files” tab, double click on the new “MESS-inference” folder and you should see your new “MESS-SIMOUT.csv.gz” file. Now you can create a “New Blank File-&gt;Rscript” in this directory by clicking on the small green plus. When prompted to enter a file name, use “MESS-classification.R”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/MESS-Classification-NewBlankFile.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Make a new blank file for the MESS inference R code</figcaption><p></p>
</figure>
</div>
<p>Now we will install a couple necessary packages: <code>randomForest</code> and <code>caret</code>, two machine learning packages for R.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## install.packages only has to happen ONCE within your R environment, you don't</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="do">## need to install.packages if you create a new file, you can skip straight</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="do">## to loading the libraries.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"randomForest"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="at">pkgs =</span> <span class="st">"caret"</span>, <span class="at">dependencies =</span> <span class="fu">c</span>(<span class="st">"Depends"</span>, <span class="st">"Imports"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Make sure you're _in_ the MESS-inference working directory</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/home/rstudio/MESS-inference"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="load-the-pre-baked-simulations" class="level4" data-number="11.3.4.3">
<h4 data-number="11.3.4.3" class="anchored" data-anchor-id="load-the-pre-baked-simulations"><span class="header-section-number">11.3.4.3</span> <strong>Load the pre-baked simulations</strong></h4>
<p>Simulation results are composed of ‘parameters’ and ‘data’. Parameters are what goes in to the simulation model and data is what comes out.</p>
<p>Before, we had used <code>core$load_sims()</code> to load the simulations generated by a specific MESS <code>Core</code> object, but here we have a <em>file</em> that we got from the internet. There was a <code>Core</code> objec that created this somewhere, but we don’t have access to it. Luckily, there is a utility function (<code>MESS$load_local_sims()</code>) which allows us to load data from an external file. Let’s use it now:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>simdata <span class="ot">=</span> MESS<span class="sc">$</span><span class="fu">load_local_sims</span>(<span class="st">"MESS-SIMOUT.csv"</span>)[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The simulated data is in the form that we have already looked at previously, so we don’t need to look at it again here now, there’s just a lot more of it.</p>
</section>
<section id="transform-the-simulations" class="level4" data-number="11.3.4.4">
<h4 data-number="11.3.4.4" class="anchored" data-anchor-id="transform-the-simulations"><span class="header-section-number">11.3.4.4</span> <strong>Transform the simulations</strong></h4>
<p>In some cases parameters/data must be reshaped in some way to make it more appropriate for the ML approach.</p>
<p>One constraint of the <code>randomForest</code> classification process is that the “target” variable (or “response” variable) must be an R <code>factor</code>, which is essentially a categorical variable. We can convert the <code>assembly_model</code> column in our <code>simdata</code> data.frame to a factor, and then count the number of elements in each <code>level</code> with <code>table()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>simdata<span class="sc">$</span>assembly_model <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(simdata<span class="sc">$</span>assembly_model)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(simdata<span class="sc">$</span>assembly_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>competition     filtering   neutral</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>       1000          1000       999</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
A perfectly reasonable explanation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If anyone can guess why this is, I will buy you dinner tonight.</p>
</div>
</div>
</div>
</section>
<section id="split-the-data-into-trainingtesting-sets" class="level4" data-number="11.3.4.5">
<h4 data-number="11.3.4.5" class="anchored" data-anchor-id="split-the-data-into-trainingtesting-sets"><span class="header-section-number">11.3.4.5</span> <strong>Split the data into training/testing sets</strong></h4>
<p>If you train a machine learning model with <strong>all</strong> of your data, then you won’t have any way to really evaluate its performance. It’s very common to split data into ‘training’ and ‘testing’ sets, where the training data used to train the model and the testing data is used to evaluate how well it performs.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 70/30 test/train split</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">2</span>, <span class="fu">nrow</span>(simdata), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> simdata[tmp<span class="sc">==</span><span class="dv">1</span>,]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> simdata[tmp<span class="sc">==</span><span class="dv">2</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="train-the-model-on-the-training-set" class="level4" data-number="11.3.4.6">
<h4 data-number="11.3.4.6" class="anchored" data-anchor-id="train-the-model-on-the-training-set"><span class="header-section-number">11.3.4.6</span> <strong>Train the model on the training set</strong></h4>
<p>Learn a mapping between patterns in the data and community assembly model.</p>
<p>The <code>randomForest()</code> function takes two important arguments:</p>
<ol type="1">
<li>The <code>data</code> upon which to operate, in this case the <code>train</code> set of training data</li>
<li>A <code>formula</code> describing the desired model of the relationship between dependent variables (on the left of the <code>~</code>) and independent variables (on the right of the <code>~</code>).</li>
</ol>
<p>The formula below indicates that we wish to express <code>assembly_model</code> as a function of <code>local_S</code>, <code>pi_h1</code>, <code>abund_h1</code>, and <code>trait_h1</code>. We chose these 4 predictor variables to demonstrate an ML model which considers all the axes of biodiversity, without being overly complex and including <strong>all</strong> the Hill numbers for each axis of data. There’s no reason to believe this is the <em>best</em> model, and you could certainly experiment with manipulating the independent variables in this formula.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Experiment with results for different axes of data!</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(assembly_model <span class="sc">~</span> local_S <span class="sc">+</span> pi_h1 <span class="sc">+</span> abund_h1 <span class="sc">+</span> trait_h1, <span class="at">data=</span>train, <span class="at">proximity=</span><span class="cn">TRUE</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Call:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a> randomForest(formula = assembly_model ~ local_S + pi_h1 + abund_h1 + trait_h1, data = train, proximity = TRUE) </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>               Type of random forest: classification</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                     Number of trees: 500</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>No. of variables tried at each split: 2</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        OOB estimate of  error rate: 19.41%</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>Confusion matrix:</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>            competition filtering neutral class.error</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>competition         538        33     124   0.2258993</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>filtering            24       571      89   0.1652047</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>neutral              61        71     560   0.1907514</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
<strong>Tuning model parameters, feature selection, iterating performance evaluation</strong>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>There is a <em>LOT</em> of fancy stuff that we are <em>NOT</em> going to do in this workshop, so please don’t imagine we are giving you the full picture. We are doing enough to give a <strong>flavor</strong> of how ML inference works, and to show that even when done ‘quick and dirty’ it still works pretty okay. To do this properly would require an entire workshop in itself, which we would encourage you to look into in the future!</p>
</div>
</div>
</div>
</section>
<section id="test-the-model-on-the-testing-set" class="level4" data-number="11.3.4.7">
<h4 data-number="11.3.4.7" class="anchored" data-anchor-id="test-the-model-on-the-testing-set"><span class="header-section-number">11.3.4.7</span> <strong>Test the model on the testing set</strong></h4>
<p>How well does the trained model recover the ‘known’ assembly model in simulations that it hasn’t seen yet.</p>
<p>Now we have trained the <code>rf</code> model and it’s time to evaluate how well it can classify simulations that it hasn’t previously seen. This is exactly what the testing dataset is <strong>for!</strong> We can use the testing data, which the rf model has not encountered, to determine accuracy of classification on <em>new</em> data.</p>
<p>We use the built-in R function <code>predict()</code> to feed the <code>test</code> data to the trained <code>rf</code> model, and it will record classification predictions for each simulation in the training set.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, test)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(test_predictions, test<span class="sc">$</span>assembly_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>Confusion Matrix and Statistics</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>             Reference</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>Prediction    competition filtering neutral</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  competition         233        13      32</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  filtering            23       270      28</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  neutral              49        33     247</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>Overall Statistics</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                                         </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>               Accuracy : 0.8082         </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                 95% CI : (0.7814, 0.833)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    No Information Rate : 0.3405         </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    P-Value [Acc &gt; NIR] : &lt; 2e-16        </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                                         </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>                  Kappa : 0.7122         </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>                                         </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a> Mcnemar's Test P-Value : 0.08011        </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>Statistics by Class:</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>                     Class: competition Class: filtering Class: neutral</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>Sensitivity                      0.7639           0.8544         0.8046</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>Specificity                      0.9278           0.9167         0.8680</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>Pos Pred Value                   0.8381           0.8411         0.7508</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>Neg Pred Value                   0.8892           0.9242         0.8998</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>Prevalence                       0.3287           0.3405         0.3308</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>Detection Rate                   0.2511           0.2909         0.2662</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>Detection Prevalence             0.2996           0.3459         0.3545</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>Balanced Accuracy                0.8459           0.8855         0.8363</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The simplest way to evaluate classification accuracy is to look at the “Confusion matrix”. In the testing set we <em>know</em> the true assembly model the data was generated under, and we want to know how often the trained RF model is able to recover the known assembly model from the held out testing data. The confusion matrix reports the contingency table of reference vs predicted assembly model outcomes. With perfect classification you would expect 100% agreement between the ‘Reference’ model and the ‘Prediction’ model, with all values in the confusion matrix falling along the diagonal. Off-diagonal elements represent the frequency of mis-classification and the category of the mis-classified prediction (e.g.&nbsp;predictions of ‘neutral’ when the known assembly model was ‘competition’).</p>
<p>Already we can see that classification accuracy is relatively high, with the majority of testing simulations being accurately classified, and few (~15%) being mis-classified in one way or the other.</p>
<p>It can sometimes be useful to visualize confusion matrices using the <code>heatmap</code> function in base R, which produces a plot representing exactly the data in the contingency table above.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">heatmap</span>(cm<span class="sc">$</span>table, <span class="at">Rowv=</span><span class="cn">NA</span>, <span class="at">Colv=</span><span class="cn">NA</span>, <span class="at">margins=</span><span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">12</span>), <span class="at">xlab=</span><span class="st">"Prediction"</span>, <span class="at">ylab=</span><span class="st">"Reference"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/MESS-Classification-ConfusionMatrix.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Visualization of the confusion matrix</figcaption><p></p>
</figure>
</div>
</section>
<section id="getting-prediction-probabilities-for-one-individual-simulation" class="level4" data-number="11.3.4.8">
<h4 data-number="11.3.4.8" class="anchored" data-anchor-id="getting-prediction-probabilities-for-one-individual-simulation"><span class="header-section-number">11.3.4.8</span> <strong>Getting prediction probabilities for one individual simulation</strong></h4>
<p>When we call <code>predict(rf, test)</code> we are using the classifier to make predictions for <strong>all</strong> the simulations in the testing set. This takes the single assembly model with the highest prediction probability as the predicted value (essentially it is a point estimate). Often it is useful (particularly with empirical data) to have a more comprehensive view of the prediction probabilities across classes. We can pass in just one simulated dataset and ask <code>predict</code> to give us the <code>type="prob"</code>, which will return exactly these.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the first row of testing data as just one simulation to predict</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># `type="prob" indicates that we wish to return the percent probability of</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># each assembly_model, rather than the point estimate.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>p_emp <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, test[<span class="dv">1</span>, ], <span class="at">type=</span><span class="st">"prob"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>p_emp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>  competition filtering neutral</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>1       0.016      0.04   0.944</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Activity:</strong> Spend a few moments making predictions for several other of the simulated datasets by changing the <code>1</code> above to <code>2</code> or <code>3</code> or some other integer values, just to get the hang of it.</p>
</section>
</section>
<section id="predict-assembly-model-of-empirical-data" class="level3" data-number="11.3.5">
<h3 data-number="11.3.5" class="anchored" data-anchor-id="predict-assembly-model-of-empirical-data"><span class="header-section-number">11.3.5</span> <strong>Predict assembly model of empirical data</strong></h3>
<p>And “Embrace the uncertainty in the model classification.</p>
<p>Now we will do a brief analysis of some empirical data, so you can see that the classification prediction process for empirical data is identical to that of simulated data: training the model and calling <code>predict</code>.</p>
<p>For this exercsie we will use genetic data from a soil arthropod metabarcoding study published by <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/mec.16275">Noguerales et al (2021)</a>. The data is comprised of soil micro-arthropod COI sequences sampled from four different habitat types in the montane forests of Cyprus. Fetch the empirical data from Noguerales et al 2021 (which we have again preprocessed and stored on github):</p>
<p>In the terminal <code>wget</code> the data for one habitat type from the workshop repository:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>## Be sure you are in the right working directory inside the terminal</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cd /home/rstudio/MESS-Inference</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>wget https://github.com/role-model/process-models-workshop/raw/main/empirical_data/Qa_hills.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now go back into the R console and load the data for this sample. It might also help to take a quick look at what the data for this sample looks like, so also print it to the screen.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>Qa_emp <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"/home/rstudio/MESS-inference/Qa_hills.txt"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>Qa_emp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  local_S   pi_h1    pi_h2    pi_h3</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>1     156 48.5767 41.83594 37.69666</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The empirical data was generated from a metabarcoding dataset, and for this exercise we provide the data already collapsed into summary statistics: the number of species in the local community (<code>local_S</code>) and the first three Hill numbers of genetic diversity (<code>pi_h1</code>, <code>pi_h2</code>, <code>pi_h3</code>). Earlier when we fit the randomForest model we used the first Hill numbers of abundance, traits, and genetic data, so before we can <code>predict()</code> community assembly model with the real data we need to <em>re-fit</em> the rf classifier so it’s predictor variables match those of the empirical data.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model including only genetic Hill numbers to the training set</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(assembly_model <span class="sc">~</span> local_S <span class="sc">+</span> pi_h1 <span class="sc">+</span> pi_h2 <span class="sc">+</span> pi_h3, <span class="at">data=</span>train, <span class="at">proximity=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(rf, Qa_emp, <span class="at">type=</span><span class="st">"prob"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>  competition filtering neutral</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>1       0.172     0.742   0.086</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Other empirical data from Noguerales et al 2021
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>wget https://github.com/role-model/process-models-workshop/raw/main/empirical_data/Cb_hills.txt
wget https://github.com/role-model/process-models-workshop/raw/main/empirical_data/Pb_hills.txt
wget https://github.com/role-model/process-models-workshop/raw/main/empirical_data/Pn_hills.txt</code></pre>
</div>
</div>
</div>
</section>
<section id="hands-on-exercise-predicting-assembly_model-of-mystery-simulations" class="level3" data-number="11.3.6">
<h3 data-number="11.3.6" class="anchored" data-anchor-id="hands-on-exercise-predicting-assembly_model-of-mystery-simulations"><span class="header-section-number">11.3.6</span> Hands-on Exercise: Predicting <code>assembly_model</code> of mystery simulations</h3>
<p>Time allowing, you may wish to try to classify some simulated multi-dimensional biodiversity data with unknown (to you) <code>assembly_model</code> values. There exists a new simulated data file which contains 20 mystery simulations with random <code>assembly_model</code> values. Choose one of these and try to re-run the classification procedure we just completed.</p>
<p>First go into your terminal and download the mystery simulations:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/rstudio/MESS-inference</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/role-model/process-models-workshop/raw/main/data/Mystery-data.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now see if you can load the mystery simulations and do the classification inference on one or a couple of them. Try to do this on your own, but if you get stuck you can check the hint here:</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Hints: Loading the mystery sims and making predictions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Importing the mystery data</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>mystery_sims <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"/home/rstudio/MESS-inference/Mystery-data.csv"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Predict for mystery sim 1</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>myst_sim <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>mystery_pred <span class="ot">=</span> <span class="fu">predict</span>(rf, mystery_sims[myst_sim, ], <span class="at">type=</span><span class="st">"prob"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mystery_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>A link to the key containing the true <code>assembly_model</code> values is hidden below. Don’t peek until you have a guess for your simulated data! How close did you get?</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
The Key is here
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="data/Mystery-key.csv">Assembly models per mystery simulation are in this file</a></p>
</div>
</div>
</div>
</section>
<section id="more-to-explore-with-r-randomforest-package" class="level3" data-number="11.3.7">
<h3 data-number="11.3.7" class="anchored" data-anchor-id="more-to-explore-with-r-randomforest-package"><span class="header-section-number">11.3.7</span> More to explore with R <code>randomForest</code> package</h3>
<p>This is just a tiny taste of the <code>randomForest</code> R package, and a tiny molecule of everything possible with machine learning, but we hope it gives the flavor still.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
More to explore if you are ahead of the group
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><strong>Evaluate variable importances</strong></p>
<p>Which axes of data contribute most to distinguishing assembly models? Details of how and why this works are left as an exercise to the enthusiastic reader.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">sort =</span> T,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">n.var =</span> <span class="dv">4</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Variable Importance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/MESS-Classification-VariableImportance.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Variable importance in RF classification</figcaption><p></p>
</figure>
</div>
<p><strong>Multidimensional scaling</strong></p>
<p><code>MDSplot()</code> is another way to inspect how the simulations are being clustered by the RF model. It’s a little too much ‘inside baseball’ for this workshop, but if you get ahead of the group you should try it out.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">MDSplot</span>(rf, train<span class="sc">$</span>assembly_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/MESS-Classification-MDSplot.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">MDSplot depicting the clustering of simulations by assembly model</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="key-points" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="key-points"><span class="header-section-number">11.4</span> Key points</h2>
<ul>
<li>Machine learning models can be used to “classify” categorical response variables given multi-dimensional input data.</li>
<li>Major components of machine learning inference include gathering and transforming data, splitting data into training and testing sets, training the ml model, and evaluating model performance.</li>
<li>ML inference is <strong>inherently</strong> uncertain, so it is important to evaluate uncertainty in ml prediction accuracy and propagate this into any downstream interpretation when applying ml to empirical data.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./mess_simulations.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using MESS API mode in RStudio to explore hypotheses</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ml_inference_regression.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ML parameter estimation with MESS simulations</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>